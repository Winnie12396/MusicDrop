<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://rawgit.com/mayognaise/aframe-mouse-cursor-component/master/dist/aframe-mouse-cursor-component.min.js"></script>
    <script src="/script.js" defer></script>
    
      <!-- for firebase-->
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-analytics.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@6.1.0/firebase.js"></script>
    
  </head>

  <body>
   
 

    <a-scene id="scene"
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    >
      
      <a-entity id="mouseCursor" cursor="rayOrigin: mouse"></a-entity>
      
      <!-- preload assets -->
      <a-assets>
       <img id="8" src="https://cdn.glitch.global/89483f63-ef3d-4744-8f4c-8573d2216bff/8?v=1703503885351">
       <img id="day6" src="https://cdn.glitch.global/89483f63-ef3d-4744-8f4c-8573d2216bff/day6?v=1703508466374">
       <img id="nj" src="https://cdn.glitch.global/89483f63-ef3d-4744-8f4c-8573d2216bff/nj?v=1703508893654">
       <img id="sea" src="https://cdn.glitch.global/89483f63-ef3d-4744-8f4c-8573d2216bff/sea?v=1703509079108">
       <img id="blue" src="https://cdn.glitch.global/89483f63-ef3d-4744-8f4c-8573d2216bff/blue?v=1703509227911">
       <img id="magnifier" src="https://cdn.glitch.global/89483f63-ef3d-4744-8f4c-8573d2216bff/magnifier?v=1703513224112">
       <img id="start" src="https://cdn.glitch.global/89483f63-ef3d-4744-8f4c-8573d2216bff/start.png?v=1703681554958">
      </a-assets>
      
      <!-- 目前放target是用複製再改參數的方式，因為create有點問題，這一個target是原本就在場景中，供複製用的 -->
      <a-entity
        look-at="[gps-camera]"
        scale="4 4 4"
        gps-entity-place="latitude: 24.79619; longitude: 120.965503;"
        gltf-model="https://cdn.glitch.global/e736c334-0e89-43a8-8057-317fdec0b1ac/target.gltf?v=1702898139269"
        id="tobecloned"
        visible="false"
      ></a-entity>
      

      <a-camera gps-camera rotation-reader positionminaccuracy: 1; gpsmindistance: 1 wasd-controls-enabled="false" look-controls mouse-cursor> 
      
        <!-- 這裡面包的是按下圓形按鈕後出現的ui選單 -->
        <a-box position="0 -1 -3" rotation="0 0 0" material="side: double; color: #EF2D5E; opacity: 0" >
          <a-entity id="buttonPut"
          class="clickable"
          shadow="cast:false;"
          geometry="primitive: circle" 
          material="opacity:0; color:white"
          side="single"
          scale="0.1, 0.1"
          position="0 0.3 2"
          opacity="0"
          ></a-entity> 
         
          <a-entity id="chooseMusic"
          class="clickable"
          shadow="cast:false;"
          geometry="primitive: plane" 
          material="opacity:0"
          side="single"
          scale="3.3, 5.3"
          position="0 1 0"
          ></a-entity>
          
          <a-entity id="search"
          class="clickable"
          shadow="cast:false;"
          geometry="primitive: plane" 
          material="opacity:0; color:#b9d1ff"
          side="single"
          scale="3, 0.35"
          position="0 3.25 0"
          opacity="0"
          ></a-entity>
          
          <!-- 這些是按了會放下target的按鈕 -->
          <a-entity id="music1"
          class="clickable"
          shadow="cast:false;"
          geometry="primitive: plane" 
          material="opacity:0; color:#b9d1ff"
          side="single"
          scale="2, 0.47"
          position="0 2.112 1"
          musicurl="https://www.youtube.com/watch?v=C_eSHj7W54E"
          musicdrop
          ></a-entity>
          
          <a-entity id="music2"
          class="clickable"
          shadow="cast:false;"
          geometry="primitive: plane" 
          material="opacity:0; color:#b9d1ff"
          side="single"
          scale="2, 0.47"
          position="0 1.608 1"
          musicurl="https://www.youtube.com/watch?v=_NmzMzjoJyk"
          musicdrop
          ></a-entity>
          
          <a-entity id="music3"
          class="clickable"
          shadow="cast:false;"
          geometry="primitive: plane" 
          material="opacity:0; color:#b9d1ff"
          side="single"
          scale="2, 0.47"
          position="0 1.104 1"
          musicurl="https://www.youtube.com/watch?v=11cta61wi0g"
          musicdrop
          ></a-entity>
          
          <a-entity id="music4"
          class="clickable"
          shadow="cast:false;"
          geometry="primitive: plane" 
          material="opacity:0; color:#b9d1ff"
          side="single"
          scale="2, 0.47"
          position="0 0.6 1"
          musicurl="https://www.youtube.com/watch?v=cPAbx5kgCJo"
          musicdrop
          ></a-entity>
          
          <a-entity id="music5"
          class="clickable"
          shadow="cast:false;"
          geometry="primitive: plane" 
          material="opacity:0; color:#b9d1ff"
          side="single"
          scale="2, 0.47"
          position="0 0.096 1"
          musicurl="https://www.youtube.com/watch?v=zuoVd2QNxJo"          
          musicdrop
          ></a-entity>
          
          <!-- 歌曲選單，目前沒有搜尋功能，只能放我們列的這幾首 -->
          <a-image id="img1" src="#8" position="-0.77 2.111 1" width="0.465" height="0.465" opacity="0"></a-image>          
          <a-image id="img2" src="#day6" position="-0.77 1.607 1" width="0.465" height="0.465" opacity="0"></a-image>          
          <a-image id="img3" src="#nj" position="-0.77 1.103 1" width="0.465" height="0.465" opacity="0"></a-image>          
          <a-image id="img4" src="#sea" position="-0.77 0.599 1" width="0.465" height="0.465" opacity="0"></a-image>          
          <a-image id="img5" src="#blue" position="-0.77 0.095 1" width="0.465" height="0.465" opacity="0"></a-image>          
          <a-image id="img6" src="#magnifier" position="1.34 3.25 0" width="0.345" height="0.345" opacity="0"></a-image>          
          <a-image id="startButton" src="#start" position="0 1.15 1.3" width="1" height="0.5" opacity="1"></a-image>
          <a-text id="text1" value="Hai Cheng" color="#6BA2E4" position="-0.47 2.216 1" scale="0.55 0.55" opacity="0"></a-text>          
          <a-text id="text2" value="Where the sea sleeps" color="#6BA2E4" position="-0.47 1.712 1" scale="0.55 0.55" opacity="0"></a-text>          
          <a-text id="text3" value="Hype Boy" color="#6BA2E4" position="-0.47 1.208 1" scale="0.55 0.55" opacity="0"></a-text>          
          <a-text id="text4" value="How Far I'll Go" color="#6BA2E4" position="-0.47 0.704 1" scale="0.55 0.55" opacity="0"></a-text>        
          <a-text id="text5" value="Where Our Blue Is" color="#6BA2E4" position="-0.47 0.2 1" scale="0.55 0.55" opacity="0"></a-text>         
          <a-text id="name1" value="Xu Ming Hao" color="#6BA2E4" position="-0.45 2.016 1" scale="0.3, 0.3" opacity="0"></a-text>          
          <a-text id="name2" value="Day6" color="#6BA2E4" position="-0.45 1.512 1" scale="0.3, 0.3" opacity="0"></a-text>          
          <a-text id="name3" value="New Jeans" color="#6BA2E4" position="-0.45 1.008 1" scale="0.3, 0.3" opacity="0"></a-text>         
          <a-text id="name4" value="Auli'i Cravalho" color="#6BA2E4" position="-0.45 0.504 1" scale="0.3, 0.3" opacity="0"></a-text>          
          <a-text id="name5" value="Kitani Tatsuya" color="#6BA2E4" position="-0.45 0 1" scale="0.3 0.3" opacity="0"></a-text>
                    
        </a-box>
        
      </a-camera>
    </a-scene>
    
    
    <script>
      var sceneEl = document.querySelector('a-scene');
      let cloneThis = document.getElementById("tobecloned");  //選取要被複製的那顆
      var startEl = document.getElementById("startButton");
      let gpsArr = [];
      let currentPosition = [];
      let prePosition = [];  //存前一個抓到的位置，用來判斷改變
      let currentDistrict = "district2";
      let preDistrict = "";  //區域同理
      
      AFRAME.registerComponent('musicdrop', {
        init: function () {
          var el = this.el; 
          
          el.addEventListener('click', async function () {
            
            //comeFindMe();
            var lat = getRandom(24.79390, 24.79210);
            var long = getRandom(120.96303, 120.96402);
            var url = this.getAttribute("musicurl");
            placeTarget(lat.toString(), long.toString(), url);  //抓自己的經緯度和連結->放target，demo先用亂數
            uploadNewTarget(currentDistrict, 20231228, lat, url, long, 1600);    //按鈕需要冷卻時間，不然很容易誤觸   //或是限制放的數量
            loadPage(currentDistrict);
          });
        }
      });
      
      startEl.addEventListener('click', function(){ //press start button
        //comeFindMe();   // 抓自己經緯度->抓所在區域->load，demo先寫死
        //getCurrentDistrict();
        loadPage(currentDistrict);
        loadPage("district3");
        loadPage("district4");
      });

      //firebase config here

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();


      async function retrieveData(district, itemNumber) {  //撈指定target的經緯度，這目前沒有用到
        var long, lat;
        await database.ref("/" + district + "/" + itemNumber + "/long").once("value").then((snapshot) => {
          if (snapshot.exists()) {
            long = snapshot.val();
            console.log(long);
          }
        }).catch((error) => {
          console.error(error);
        });
        await database.ref("/" + district + "/" + itemNumber + "/lat").once("value").then((snapshot) => {
          if (snapshot.exists()) {
            lat = snapshot.val();
            console.log(lat);
          }
        }).catch((error) => {
          console.error(error);
        });
        return [lat, long];

      }
      
      function placeTarget(lat, long, link){  //用新增DOM元素的方式，把target丟到頁面中
        var entityEl = cloneThis.cloneNode(true);
        //var coordinate = "latitude:" + lat + ";longitude:" + long + ";";
        entityEl.removeAttribute("gps-entity-place");
        entityEl.setAttribute('gps-entity-place', {latitude:lat, longitude:long}, true);
        entityEl.removeAttribute("id", "tobecloned");
        entityEl.setAttribute("visible", true);
        entityEl.setAttribute("link", "href", link)
        sceneEl.appendChild(entityEl);
      }
      
      async function loadPage(dis){  //從firebase撈指定區域的所有target然後放下去  //目前沒有設定要渲染到多遠
        
        await snapshotToArray(dis);
        for (let i = 0; i < gpsArr.length; i++){
          placeTarget(gpsArr[i][0].toString(), gpsArr[i][1].toString(), gpsArr[i][2].toString());
        }
        
        
      }
      
      async function snapshotToArray(district) {  //抓某一區的資料，然後把那區所有target的經緯度跟連結放到gpsArr的陣列中
        let dataArr = [];
        gpsArr = [];
        await database.ref("/" + district).once("value").then((snapshot) => {
          if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
              let item = childSnapshot.val();
              item.key = childSnapshot.key;
              dataArr.push(item);
            });
          }
        }).catch((error) => {
          console.error(error);
        });
        
        //console.log(dataArr);  // the array of all the data, each target is stored in a { }
        //console.log(dataArr[0].lat, dataArr[0].long);  // get the gps of that element
        
        for (let i = 0; i < dataArr.length; i++){
          gpsArr.push([dataArr[i].lat, dataArr[i].long, dataArr[i].link]);
        }
        
      };
      
      function comeFindMe() {  //抓自己的經緯度，demo暫時沒有用到，因為不確定他有沒有正確運作  //不確定這裡會不會有時間差的問題，還沒試
        
        function success(position) {   //如果抓到的話，就把currentPosition更新為現在位置
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          prePosition = currentPosition;
          currentPosition = [latitude, longtitude];
        }

        function error() {
          console.log("Unable to retrieve your location");
          prePosition = currentPosition;
          currentPosition = ["24.7921", "120.96601"];  //如果沒抓到，就先給寫死的座標
        }

        if (!navigator.geolocation) {
          console.log("Geolocation is not supported by your browser");
        } else {
          console.log("Locating…");
          navigator.geolocation.getCurrentPosition(success, error);
        }
        
        //console.log("cP:" + currentPosition);
      }


      function getCurrentDistrict(){  //用所在經緯度抓現在所在的區，目前沒有設定超出我們所畫的區域會怎樣
        var dis = "";
        if(currentPosition[0]>24.793906 && currentPosition[0]<=24.794837 && currentPosition[1]>=120.963033 && currentPosition[1]<=120.966928){
          dis = "district1";
        }
        else if(currentPosition[0]>=24.792100 && currentPosition[0]<=24.793906 && currentPosition[1]>=120.963033 && currentPosition[1]<=120.964020){
          dis = "district2";
        }
        else if(currentPosition[0]>=24.792100 && currentPosition[0]<24.793200 && currentPosition[1]>120.964020 && currentPosition[1]<=120.966123){
          dis = "distric3";
        }
        else if(currentPosition[0]>=24.793200 && currentPosition[0]<=24.793906 && currentPosition[1]>120.964020 && currentPosition[1]<=120.966123){
          dis = "district4";
        }
        else if(currentPosition[0]>=24.792100 && currentPosition[0]<=24.793906 && currentPosition[1]>120.966123 && currentPosition[1]<=120.966928){
          dis = "district5";
        }
        
        preDistrict = currentDistrict;
        currentDistrict = dis;
        console.log("currently at:" + currentDistrict);

      }
      
      function getRandom(min, max) {
        return Math.random() * (max - min) + min;
      }
      
      async function uploadNewTarget(district, date, lat, link, long, time){
        var number = 0;  //the key of this target in database
        await database.ref("/" + district).once("value").then((snapshot) => {  //抓現在所在那區有幾個，才知道接下來要編幾號  //還沒實作數量超過限制(使用者可以upload的數量限制or資料庫一區的數量上限)的狀況
          if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
              number++;
            });
          }
        }).catch((error) => {
          console.error(error);
        });
        
        firebase.database().ref('/' + district + '/' + number.toString()).set({  //目前上傳的日期時間是寫死的
          date: date,
          lat: lat,
          link: link,
          long: long,
          time: time
        }, (error) => {
          if (error) {
            console.log("write failed");
          } else {
            console.log("success");
          }
        });
      }
      
     
    </script>
      
      

  </body>

</html>
